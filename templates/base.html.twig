<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MotoTrack{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a","950":"#172554"}
                    }
                }
            }
        }
    </script>
    <style>
        /* Sidebar responsive */
        @media (max-width: 1023px) {
            #sidebar {
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        @media (min-width: 1024px) {
            #sidebar {
                transform: translateX(0) !important;
            }
        }
    </style>
    {% block stylesheets %}{% endblock %}
</head>
<body class="h-full">
<div class="min-h-full">
    <!-- Mobile overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-900/50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-gray-900 transition-transform duration-300 ease-in-out" id="sidebar">
        <div class="flex h-16 shrink-0 items-center justify-between px-6 border-b border-gray-800">
            <div class="flex items-center">
                <i class="fas fa-motorcycle text-primary-500 text-2xl mr-3"></i>
                <span class="text-xl font-bold text-white">MotoTrack</span>
            </div>
            <!-- Close button for mobile -->
            <button onclick="toggleSidebar()" class="lg:hidden p-2 text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <nav class="flex flex-1 flex-col px-4 py-4 overflow-y-auto" style="height: calc(100vh - 140px);">
            <ul class="space-y-1" id="sidebarNav">
                <li>
                    <a href="{{ path('app_dashboard') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if app.request.attributes.get('_route') == 'app_dashboard' %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}">
                        <i class="fas fa-chart-pie w-5"></i>Dashboard
                    </a>
                </li>
                
                <li class="pt-4"><div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3">Encodage</div></li>
                <li><a href="{{ path('encoder_moto_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'encoder_moto' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-motorcycle w-5"></i>Motos</a></li>
                <li><a href="{{ path('encoder_motard_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'encoder_motard' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-user w-5"></i>Motards</a></li>
                <li><a href="{{ path('encoder_paiement_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'encoder_paiement' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-money-bill-wave w-5"></i>Paiements</a></li>

                <li class="pt-4"><div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3">Validation</div></li>
                <li><a href="{{ path('validator_paiements') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'validator_paiement' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-check-double w-5"></i>Valider Paiements</a></li>
                <li><a href="{{ path('validator_plaques') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'validator_plaque' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-id-card w-5"></i>Affecter Plaques</a></li>

                {% if is_granted('ROLE_ADMIN') %}
                <li class="pt-4"><div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3">Administration</div></li>
                <li><a href="{{ path('admin_user_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'admin_user' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-users w-5"></i>Utilisateurs</a></li>
                <li><a href="{{ path('admin_site_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'admin_site' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-map-marker-alt w-5"></i>Sites</a></li>
                <li><a href="{{ path('admin_marque_index') }}" class="group flex items-center gap-x-3 rounded-lg px-3 py-2 text-sm font-medium {% if 'admin_marque' in app.request.attributes.get('_route') %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}"><i class="fas fa-tags w-5"></i>Marques</a></li>
                {% endif %}
            </ul>
        </nav>
        <div class="absolute bottom-0 left-0 right-0 border-t border-gray-800 p-4 bg-gray-900">
            <a href="{{ path('app_logout') }}" class="flex items-center gap-x-3 text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-sign-out-alt"></i><span class="text-sm">Déconnexion</span>
            </a>
        </div>
    </div>

    <!-- Main content -->
    <div class="lg:pl-64">
        <!-- Top bar -->
        <header class="sticky top-0 z-40 bg-white shadow-sm border-b border-gray-200">
            <div class="flex h-16 items-center justify-between px-4 lg:px-6">
                <div class="flex items-center gap-3">
                    <!-- Mobile menu button -->
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 class="text-lg font-semibold text-gray-900">{% block page_title %}{% endblock %}</h1>
                </div>
                
                <div class="flex items-center gap-x-4">
                    <span class="text-sm text-gray-500 hidden md:block">{{ "now"|date("d/m/Y H:i") }}</span>
                    
                    <!-- Notification bell with dropdown -->
                    <div class="relative">
                        <button onclick="toggleNotifMenu()" class="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full transition-colors">
                            <i class="fas fa-bell text-xl"></i>
                            {% set notifCount = notification_count|default(0) %}
                            {% if notifCount > 0 %}
                            <span class="absolute -top-1 -right-1 h-5 w-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse">
                                {{ notifCount }}
                            </span>
                            {% endif %}
                        </button>
                        
                        <!-- Notifications dropdown -->
                        <div id="notifMenu" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-gray-200 z-50">
                            <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-900">Notifications</h3>
                                {% if notifCount > 0 %}
                                <span class="bg-red-100 text-red-600 text-xs font-medium px-2 py-1 rounded-full">{{ notifCount }} nouvelle(s)</span>
                                {% endif %}
                            </div>
                            <div class="max-h-80 overflow-y-auto">
                                {% if notifCount > 0 %}
                                    {% for i in 1..min(notifCount, 5) %}
                                    <div class="px-4 py-3 hover:bg-gray-50 border-b border-gray-50 cursor-pointer" onclick="window.location='{{ path('validator_paiements') }}'">
                                        <div class="flex items-start gap-3">
                                            <div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                                                <i class="fas fa-clock text-yellow-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900">Paiement en attente</p>
                                                <p class="text-xs text-gray-500 mt-0.5">Un paiement nécessite votre validation</p>
                                                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-clock mr-1"></i>Il y a quelques minutes</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <div class="px-4 py-8 text-center">
                                    <div class="h-12 w-12 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-bell-slash text-gray-400"></i>
                                    </div>
                                    <p class="text-sm text-gray-500">Aucune notification</p>
                                </div>
                                {% endif %}
                            </div>
                            {% if notifCount > 0 %}
                            <div class="px-4 py-3 border-t border-gray-100 bg-gray-50 rounded-b-xl">
                                <a href="{{ path('validator_paiements') }}" class="block text-center text-sm font-medium text-primary-600 hover:text-primary-700">
                                    Voir tous les paiements en attente <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- User dropdown -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center gap-x-3 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <div class="h-9 w-9 rounded-full bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center shadow-md">
                                <span class="text-white font-semibold text-sm">{{ app.user.nom|first|upper }}</span>
                            </div>
                            <div class="hidden md:block text-left">
                                <p class="text-sm font-medium text-gray-900">{{ app.user.nom }}</p>
                                <p class="text-xs text-gray-500">{{ app.user.roles[0]|replace({'ROLE_': ''})|capitalize }}</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 text-xs hidden md:block"></i>
                        </button>
                        
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-900">{{ app.user.nom }}</p>
                                <p class="text-xs text-gray-500">{{ app.user.email }}</p>
                            </div>
                            <a href="#" class="flex items-center gap-x-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-user-circle text-gray-400"></i>Mon profil</a>
                            <a href="#" class="flex items-center gap-x-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-cog text-gray-400"></i>Paramètres</a>
                            <div class="border-t border-gray-100 mt-2 pt-2">
                                <a href="{{ path('app_logout') }}" class="flex items-center gap-x-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i class="fas fa-sign-out-alt"></i>Déconnexion</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 lg:p-6">
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                <div class="mb-4 rounded-lg p-4 {% if label == 'success' %}bg-green-50 text-green-800 border border-green-200{% elseif label == 'error' or label == 'danger' %}bg-red-50 text-red-800 border border-red-200{% elseif label == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                    <div class="flex items-center"><i class="fas {% if label == 'success' %}fa-check-circle{% elseif label == 'error' or label == 'danger' %}fa-exclamation-circle{% elseif label == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-2"></i>{{ message }}</div>
                </div>
                {% endfor %}
            {% endfor %}
            {% block body %}{% endblock %}
        </main>
    </div>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('hidden');
}

// Close sidebar on mobile when clicking a nav link
document.getElementById('sidebarNav').addEventListener('click', function(e) {
    if (e.target.closest('a') && window.innerWidth < 1024) {
        toggleSidebar();
    }
});

function toggleNotifMenu() {
    document.getElementById('notifMenu').classList.toggle('hidden');
    document.getElementById('userMenu').classList.add('hidden');
}

function toggleUserMenu() {
    document.getElementById('userMenu').classList.toggle('hidden');
    document.getElementById('notifMenu').classList.add('hidden');
}

document.addEventListener('click', function(event) {
    const notifMenu = document.getElementById('notifMenu');
    const userMenu = document.getElementById('userMenu');
    const isNotifButton = event.target.closest('button[onclick="toggleNotifMenu()"]');
    const isUserButton = event.target.closest('button[onclick="toggleUserMenu()"]');
    
    if (!isNotifButton && !notifMenu.contains(event.target)) {
        notifMenu.classList.add('hidden');
    }
    if (!isUserButton && !userMenu.contains(event.target)) {
        userMenu.classList.add('hidden');
    }
});
</script>
{% block javascripts %}{% endblock %}
</body>
</html>
